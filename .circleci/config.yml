version: 2.1

aliases:
  - &param_stack_yaml
    stack_yaml:
      type: string
      default: stack.yaml

  - &cache_key
    v0-{{ checksum "cache-key.txt" }}

executors:
  centos7:
    parameters:
      <<: *param_stack_yaml

    docker:
      - image: centos:7
    working_directory: /root/src
    shell: /bin/bash -eux -o pipefail
    environment:
      STACK_YAML: << parameters.stack_yaml >>

jobs:
  run_build_and_test:
    parameters:
      <<: *param_stack_yaml

    executor:
      name: centos7
      stack_yaml: << parameters.stack_yaml >>

    steps:
      # init
      - checkout
      - run:
          name: Build cache key
          command: |
            FILES=(
              "${STACK_YAML}"
              package.yaml
            )
            cat "${FILES[@]}" > cache-key.txt

      # install stack and dependencies
      - run:
          name: Install stack
          command: |
            curl -sSL https://get.haskellstack.org/ | sh
            stack --version
      - restore_cache:
          key: *cache_key
      - run:
          name: Build external dependencies
          command: |
            stack build --test --haddock --only-dependencies
            # build hlint/stylish-haskell for cache
            stack build hlint stylish-haskell
      - save_cache:
          key: *cache_key
          paths:
            - ~/.stack
            - .stack-work

      # lint, build, and test
      - run:
          name: Lint
          command: |
            set +e
            STATUS=0
            scripts/hlint.sh || STATUS=1
            scripts/stylish-haskell.sh || STATUS=1
            exit "${STATUS}"
      - run:
          name: Build
          command: stack build --test --no-run-tests --haddock
      - run:
          name: Test
          command: stack test

workflows:
  version: 2

  build_and_test:
    jobs:
      - run_build_and_test:
          name: test_ghc_8.6
          stack_yaml: stack-lts-13.22.yaml
      - run_build_and_test:
          name: test_ghc_8.4
          stack_yaml: stack-lts-12.26.yaml
      - run_build_and_test:
          name: test_ghc_8.2
          stack_yaml: stack-lts-11.22.yaml
      - run_build_and_test:
          name: test_ghc_8.0
          stack_yaml: stack-lts-9.21.yaml
      - run_build_and_test:
          name: test_ghc_7.10
          stack_yaml: stack-lts-6.35.yaml
      - run_build_and_test:
          name: test_ghc_7.8
          stack_yaml: stack-lts-2.22.yaml
